{% extends "base.html" %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.2/otpauth.umd.min.js"></script>

<div style="max-width: 600px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 8px; border: 1px solid #e1e4e8;">

    <h2 style="border-bottom: 2px solid #f4f6f9; padding-bottom: 10px; margin-bottom: 20px;">Submit Account Task</h2>

    {% if stop_task %}
        <div style="text-align: center; padding: 30px; background: #fff3cd; color: #856404; border-radius: 5px;">
            <h3>‚ö†Ô∏è Submissions Paused</h3>
            <p>We are not accepting new tasks at the moment.</p>
        </div>
    {% else %}

        <div style="background: #e3f2fd; padding: 20px; border-radius: 5px; border: 1px solid #90caf9; margin-bottom: 25px;">
            <h4 style="margin: 0 0 15px 0; color: #0d47a1; border-bottom: 1px solid #bbdefb; padding-bottom: 5px;">üîê System Credentials</h4>

            <div style="margin-bottom: 10px;">
                <label style="font-size: 13px; color: #555; font-weight: bold;">Password (Use This):</label>
                <div style="display: flex; background: white; padding: 5px; border-radius: 3px; border: 1px solid #ccc;">
                    <span style="font-family: monospace; font-size: 16px; flex-grow: 1;">{{ gen_pass }}</span>
                </div>
            </div>

            <div>
                <label style="font-size: 13px; color: #555; font-weight: bold;">Recovery Email (Use This):</label>
                <div style="display: flex; background: white; padding: 5px; border-radius: 3px; border: 1px solid #ccc;">
                    <span style="font-family: monospace; font-size: 16px; flex-grow: 1;">{{ gen_recovery }}</span>
                </div>
            </div>
            <p style="font-size: 12px; color: #d32f2f; margin-top: 10px; font-weight: bold;">
                *You MUST use these details. Do not use your own password.
            </p>
        </div>

        <form id="taskForm" method="POST" action="{{ url_for('submit_task') }}">

            <input type="hidden" name="password" value="{{ gen_pass }}">
            <input type="hidden" name="recovery_email" value="{{ gen_recovery }}">

            <div style="margin-bottom: 20px;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 5px;">Created Email Address:</label>
                <input type="email" name="email" required placeholder="Enter the gmail you created..." 
                       style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
                <small style="color: #666;">Type the email address you just created using the credentials above.</small>
            </div>

            <div style="margin-bottom: 20px; padding: 15px; background: #f0f2f5; border: 2px dashed #ccc; border-radius: 5px; text-align: center;">
                <label style="font-weight: bold; color: #333; display: block; margin-bottom: 10px;">Upload Authenticator QR</label>
                <input type="file" id="qr_file" accept="image/*" style="width: 100%;" onchange="processQR()">
                <small id="upload_status" style="display: block; margin-top: 5px; color: #666; font-weight: bold;"></small>
            </div>

            <input type="hidden" name="secret_code" id="hidden_secret">

            <div id="otp_display_area" style="display: none; margin-bottom: 25px; padding: 20px; background: #e3f2fd; border-radius: 8px; text-align: center; border: 1px solid #90caf9;">
                <h4 style="margin: 0 0 10px 0; color: #0d47a1;">Live Code</h4>
                <div id="live_code" style="font-size: 32px; font-weight: bold; letter-spacing: 5px; color: #1565c0; font-family: monospace;">--- ---</div>
                <div style="width: 100%; background: #bbdefb; height: 5px; margin-top: 10px; border-radius: 5px;">
                    <div id="otp_progress" style="width: 100%; background: #1976d2; height: 100%; border-radius: 5px; transition: width 1s linear;"></div>
                </div>
                <p style="margin-top: 10px; font-size: 13px; color: #555;">‚úÖ Secret Key Extracted!</p>
            </div>

            <button type="submit" id="submit_btn" disabled class="btn" style="background-color: #ccc; width: 100%; padding: 12px; font-size: 16px; font-weight: bold; cursor: not-allowed;">Waiting for QR...</button>
        </form>
    {% endif %}
</div>

<script>
    async function processQR() {
        let fileInput = document.getElementById('qr_file');
        let statusText = document.getElementById('upload_status');
        if (fileInput.files.length === 0) return;
        let formData = new FormData();
        formData.append("qr_file", fileInput.files[0]);
        statusText.innerText = "‚è≥ Extracting..."; statusText.style.color = "blue";
        try {
            let response = await fetch('/api/process_qr', { method: 'POST', body: formData });
            let result = await response.json();
            if (result.success) {
                statusText.innerText = "‚úÖ Secret Found."; statusText.style.color = "green";
                document.getElementById('hidden_secret').value = result.secret;
                startOTPGenerator(result.secret);
                document.getElementById('otp_display_area').style.display = 'block';
                let btn = document.getElementById('submit_btn');
                btn.disabled = false; btn.style.backgroundColor = '#28a745'; btn.style.cursor = 'pointer'; btn.innerHTML = 'üöÄ Submit Task';
            } else { statusText.innerText = "‚ùå " + result.error; statusText.style.color = "red"; }
        } catch (error) { statusText.innerText = "‚ùå Error!"; }
    }
    function startOTPGenerator(secret) {
        try {
            const totp = new OTPAuth.TOTP({ algorithm: 'SHA1', digits: 6, period: 30, secret: OTPAuth.Secret.fromBase32(secret) });
            setInterval(() => {
                let token = totp.generate();
                document.getElementById('live_code').innerText = token.substring(0, 3) + " " + token.substring(3, 6);
                let epoch = Math.floor(Date.now() / 1000);
                let progress = (epoch % 30) / 30 * 100;
                document.getElementById('otp_progress').style.width = (100 - progress) + "%";
            }, 1000);
        } catch (e) {}
    }
</script>
{% endblock %}
