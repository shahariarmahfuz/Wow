{% extends "base.html" %}

{% block content %}

<style>
    /* ========================= DESIGN STYLES ========================= */
    :root{
        --bg-body: #ffffff;
        --card-bg: #ffffff;
        --text-main: #111827;
        --border: #e5e7eb;
        --shadow: 0 18px 40px rgba(0,0,0,0.12);
        --gradient-btn: linear-gradient(to right, #f59e0b, #ef4444);
        --input-bg: #ffffff;
    }
    
    .st-wrap{
        max-width: 900px;
        margin: 22px auto; 
        padding: 0 20px;
        position: relative;
        z-index: 1;
    }
    .st-card{
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: 20px;
    }
    .st-head{
        padding: 18px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(10px);
    }
    .st-title{ font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0; }
    .st-badge{
        display: inline-flex; align-items: center; padding: 6px 12px;
        border-radius: 999px; font-size: 11px; font-weight: 700;
        border: 1px solid rgba(0,0,0,0.08); background: rgba(0,0,0,0.04);
        color: #374151; text-transform: uppercase; letter-spacing: .6px;
    }
    .st-body{ padding: 22px; }

    /* Notice Box */
    .notice{
        padding: 12px; border-radius: 8px;
        border: 1px solid rgba(239,68,68,0.22);
        background: #fef2f2; color: #b91c1c;
        font-size: 14px; font-weight: 600; text-align: center;
    }
    .notice h3{ margin: 0 0 6px; }

    /* Forms */
    .form{ display: grid; gap: 14px; }
    .field label{ display: block; font-size: 14px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; }
    .input{
        width: 100%; height: 48px; padding: 0 16px;
        border-radius: 6px; border: 1px solid var(--border);
        background: var(--input-bg); font-size: 15px; font-weight: 600;
        outline: none; transition: all .15s ease;
    }
    .input:focus{ border-color: rgba(245,158,11,0.7); box-shadow: 0 0 0 3px rgba(245,158,11,0.15); }

    /* Reset Button */
    .reset-btn {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 6px 12px; background: #fee2e2; color: #991b1b;
        border: 1px solid #fecaca; border-radius: 6px;
        font-size: 12px; font-weight: 700; cursor: pointer;
        text-decoration: none; transition: all 0.2s;
    }
    .reset-btn:hover { background: #fecaca; }
    .step-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #e5e7eb;
    }

    /* Credential Box */
    .cred{
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 10px; padding: 18px;
        box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }
    .cred-head{ display:flex; justify-content:space-between; margin-bottom: 12px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
    .cred-title{ font-size: 14px; font-weight: 700; display:flex; gap:8px; align-items:center; margin:0; }
    .cred-grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 520px){ .cred-grid{ grid-template-columns: 1fr 1fr; } }
    
    .kv label{ font-size: 12px; font-weight: 600; color: #9ca3af; text-transform: uppercase; }
    .mono-box{
        display:flex; align-items:center; justify-content: space-between; gap: 10px;
        padding: 12px; border-radius: 8px; border: 1px solid #f3f4f6; background: #f9fafb;
    }
    .mono{ font-family: monospace; font-weight: 600; word-break: break-all; }
    
    .copy-btn{
        border: none; background: rgba(0,0,0,0.05); color: #0f172a;
        border-radius: 8px; padding: 8px; cursor: pointer;
    }
    .copy-btn:hover{ background: rgba(0,0,0,0.08); }

    /* OTP & Upload */
    .otp{ display: none; padding: 18px; border-radius: 10px; border: 1px solid #f3f4f6; background: #fff; text-align: center; margin-top: 15px; }
    .otp-code{ font-size: 28px; font-weight: 700; letter-spacing: 3px; font-family: monospace; }
    .bar{ width: 100%; height: 6px; border-radius: 999px; background: rgba(15,23,42,0.1); margin-top: 12px; overflow: hidden; }
    .bar > div{ height: 100%; width: 100%; background: #f59e0b; }

    .upload{
        position: relative; width: 100%; height: 120px;
        border: 2px dashed #cbd5e1; border-radius: 10px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: #f8fafc; cursor: pointer; margin-top: 15px; transition: all 0.2s;
    }
    .upload:hover{ border-color: #f59e0b; background: #fff7ed; }
    .upload input[type="file"]{ position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .upload-status.is-success{ color: #16a34a; }
    .upload-status.is-error{ color: #b91c1c; }
    .upload-status.is-loading{ color: #64748b; }

    /* Submit Button */
    .submit-btn{
        display: flex; align-items: center; justify-content: center; gap: 10px;
        width: 100%; height: 48px; margin-top: 15px;
        border-radius: 6px; border: none; background: rgba(17,24,39,0.08);
        color: #6b7280; font-weight: 700; cursor: not-allowed;
    }
    .submit-btn.is-ready{ background: var(--gradient-btn); color: #fff; cursor: pointer; }

</style>

<div class="st-wrap">
    
    <div class="st-card">
        <div class="st-head">
            <h3 class="st-title">Submit Task</h3>
            {% if task_data %}
                <span class="st-badge" style="background:#dcfce7; color:#166534;">In Progress</span>
            {% else %}
                <span class="st-badge">New</span>
            {% endif %}
        </div>
    </div>

    <div class="st-card">
        <div class="st-body">
            
            {% if stop_task %}
                <div class="notice">
                    <h3>Paused</h3>
                    <div>Task submission is currently disabled by Admin.</div>
                </div>
            {% else %}

                {# ============ STATE 1: EMAIL INPUT (NO SESSION) ============ #}
                {% if not task_data %}
                
                <form method="POST" action="{{ url_for('submit_task') }}" class="form">
                    <div class="field">
                        <label>Enter Gmail Address to Start</label>
                        <input class="input" type="email" name="step_email" required 
                               placeholder="e.g. username@gmail.com" 
                               autocomplete="off" inputmode="email">
                        <small style="color:#6b7280; display:block; margin-top:8px;">
                            <span style="color:#f59e0b;">‚ÑπÔ∏è</span> Next step will generate Password & Recovery automatically.
                        </small>
                    </div>
                    
                    <button type="submit" class="submit-btn is-ready">
                        Next Step &rarr;
                    </button>
                </form>

                {# ============ STATE 2: FULL DETAILS (SESSION EXISTS) ============ #}
                {% else %}

                <div class="step-header">
                    <div style="font-size:14px; color:#4b5563;">
                        Working on: <strong>{{ task_data.email }}</strong>
                    </div>
                    <a href="{{ url_for('submit_task', action='reset') }}" class="reset-btn" onclick="return confirm('Reset form? Current data will be lost.');">
                        ‚Üª Reset / New
                    </a>
                </div>

                <form id="taskForm" class="form" method="POST" action="{{ url_for('submit_task') }}">
                    
                    <div class="cred">
                        <div class="cred-head">
                            <h4 class="cred-title">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                System Credentials
                            </h4>
                            <span class="st-badge">Saved</span>
                        </div>
                        <div class="cred-grid">
                            <div class="kv">
                                <label>Password</label>
                                <div class="mono-box">
                                    <span class="mono" id="copy_pass">{{ task_data.password }}</span>
                                    <button type="button" class="copy-btn" onclick="copyToClipboard('copy_pass', this)">üìã</button>
                                </div>
                            </div>
                            <div class="kv">
                                <label>Recovery</label>
                                <div class="mono-box">
                                    <span class="mono" id="copy_recovery">{{ task_data.recovery }}</span>
                                    <button type="button" class="copy-btn" onclick="copyToClipboard('copy_recovery', this)">üìã</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="otp_display_area" class="otp">
                        <h4>2FA Code</h4>
                        <div class="mono-box" style="margin-top:10px;">
                            <div class="otp-code" id="live_code" style="width:100%; text-align:left;">--- ---</div>
                            <button type="button" class="copy-btn" onclick="copyToClipboard('live_code', this)">üìã</button>
                        </div>
                        <div class="otp-row" style="margin-top:10px;">
                            <div class="mono-box">
                                <span class="mono" id="secret_copy_value">------</span>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('secret_copy_value', this)">üìã</button>
                            </div>
                        </div>
                        <div class="bar"><div id="otp_progress"></div></div>
                    </div>

                    <button type="submit" id="submit_btn" class="submit-btn" disabled>
                        Waiting for QR Scan...
                    </button>

                    <div class="upload">
                        <div class="upload-title" style="font-weight:700; color:#64748b; margin-bottom:5px;">
                            üì∑ Upload QR Code
                        </div>
                        <input type="file" id="qr_file" accept="image/*" onchange="processQR()">
                        <small id="upload_status" class="upload-status">Tap to select image</small>
                    </div>

                    <input type="hidden" name="secret_code" id="hidden_secret">
                </form>

                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- IMPORTANT: Load OTPAuth BEFORE our logic uses it (and we still guard/wait if slow) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.2/otpauth.min.js"></script>

<script>
    let otpIntervalId = null;

    function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function ensureOtpAuthReady(timeoutMs = 8000) {
        if (window.OTPAuth) return true;

        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
            await sleep(100);
            if (window.OTPAuth) return true;
        }
        return false;
    }

    function normalizeSecret(secret) {
        // Base32: A-Z and 2-7 (strip spaces/newlines etc.)
        return (secret || "")
            .toString()
            .trim()
            .replace(/\s+/g, "")
            .toUpperCase()
            .replace(/[^A-Z2-7]/g, "");
    }

    function setUploadStatus(text, state) {
        const el = document.getElementById('upload_status');
        if (!el) return;
        el.className = 'upload-status ' + (state || '');
        el.textContent = text;
    }

    function setSubmitReady(isReady) {
        const btn = document.getElementById('submit_btn');
        if (!btn) return;
        btn.disabled = !isReady;
        btn.classList.toggle('is-ready', isReady);
        btn.textContent = isReady ? "‚úÖ Submit Task" : "Waiting for QR Scan...";
    }

    async function processQR() {
        const fileInput = document.getElementById('qr_file');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) return;

        setSubmitReady(false);

        const otpBox = document.getElementById('otp_display_area');
        if (otpBox) otpBox.style.display = 'none';

        const hiddenSecret = document.getElementById('hidden_secret');
        if (hiddenSecret) hiddenSecret.value = '';

        const formData = new FormData();
        formData.append("qr_file", fileInput.files[0]);
        setUploadStatus("Processing...", "is-loading");

        try {
            const response = await fetch('/api/process_qr', { method: 'POST', body: formData });

            if (!response.ok) {
                setUploadStatus("Server error while scanning QR.", "is-error");
                return;
            }

            const result = await response.json();

            if (result && result.success && result.secret) {
                const secretNorm = normalizeSecret(result.secret);

                if (!secretNorm || secretNorm.length < 16) {
                    setUploadStatus("Invalid secret from QR (format issue).", "is-error");
                    return;
                }

                setUploadStatus("Success! QR Scanned.", "is-success");

                // Set Secret
                if (hiddenSecret) hiddenSecret.value = secretNorm;

                const secretCopy = document.getElementById('secret_copy_value');
                if (secretCopy) secretCopy.textContent = secretNorm;

                // Ensure OTP library is ready
                const ok = await ensureOtpAuthReady();
                if (!ok) {
                    setUploadStatus("OTP library not loaded (CDN blocked/slow).", "is-error");
                    return;
                }

                // Start OTP
                const started = startOTPGenerator(secretNorm);
                if (!started) {
                    setUploadStatus("OTP start failed (check secret).", "is-error");
                    return;
                }

                if (otpBox) otpBox.style.display = 'block';

                // Enable Submit
                setSubmitReady(true);
            } else {
                setUploadStatus("Failed to read QR.", "is-error");
            }
        } catch (e) {
            setUploadStatus("Error uploading.", "is-error");
            console.error(e);
        }
    }

    function startOTPGenerator(secret) {
        try {
            if (!window.OTPAuth) return false;

            if (otpIntervalId) {
                clearInterval(otpIntervalId);
                otpIntervalId = null;
            }

            const totp = new OTPAuth.TOTP({
                algorithm: 'SHA1',
                digits: 6,
                period: 30,
                secret: OTPAuth.Secret.fromBase32(secret),
            });

            const liveCodeEl = document.getElementById('live_code');
            const progressEl = document.getElementById('otp_progress');

            if (!liveCodeEl || !progressEl) return false;

            const update = () => {
                const token = totp.generate();
                liveCodeEl.textContent = token.substring(0, 3) + " " + token.substring(3, 6);

                const epoch = Math.floor(Date.now() / 1000);
                const progress = (epoch % 30) / 30 * 100;
                progressEl.style.width = (100 - progress) + "%";
            };

            update();
            otpIntervalId = setInterval(update, 1000);
            return true;
        } catch (e) {
            console.error("OTP Error", e);
            return false;
        }
    }

    function copyToClipboard(elementId, btn) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const text = (el.innerText || el.textContent || "").trim();

        // clipboard API sometimes fails on non-HTTPS or older browsers
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                if (!btn) return;
                const original = btn.innerHTML;
                btn.innerHTML = "‚úÖ";
                setTimeout(() => btn.innerHTML = original, 1000);
            });
            return;
        }

        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try {
            document.execCommand('copy');
            if (btn) {
                const original = btn.innerHTML;
                btn.innerHTML = "‚úÖ";
                setTimeout(() => btn.innerHTML = original, 1000);
            }
        } catch (_) {}
        document.body.removeChild(ta);
    }
</script>

{% endblock %}
